<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dispatch NFFA</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: Inter, system-ui, sans-serif;
      margin: 0;
      min-height: 100vh;
      background: url('https://i.imgur.com/A6V1lhN.jpg') no-repeat center center fixed;
      background-size: cover;
      color: #1f1f1f;
    }
    body::before {
      content: "";
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.7);
      backdrop-filter: blur(4px);
      z-index: -1;
    }
    header {
      background: linear-gradient(90deg, #e11d48, #991b1b);
      color: white;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    button {
      background: #dc2626;
      color: white;
      border: 0;
      padding: 10px 16px;
      border-radius: 10px;
      cursor: pointer;
    }
    button:hover { background: #b91c1c; }
    .card {
      max-width: 800px;
      margin: 40px auto;
      padding: 24px;
      border-radius: 16px;
      background: rgba(255,255,255,0.95);
      box-shadow: 0 10px 25px rgba(0,0,0,.12);
    }
    .user-item {
      padding: 10px;
      border: 1px solid #fecaca;
      border-radius: 10px;
      margin: 6px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .user-item.admin { background: #fee2e2; }
    .user-item.dispatcher { background: #fee2e2aa; }
  </style>
</head>
<body>
  <header>
    <strong>Dispatch NFFA</strong>
    <button onclick="logout()">Déconnexion</button>
  </header>
  <div class="card">
    <h2 id="welcome"></h2>
    <div id="userList"></div>
  </div>

  <script>
    // Initialisation du client Supabase
    const { createClient } = supabaseJs;
    const supabase = createClient(
      'https://gktawbaposndfxijkxdk.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdGF3YmFwb3NuZGZ4aWpreGRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwNzUyNDUsImV4cCI6MjA3OTY1MTI0NX0.tY-CHuyb2zr9s6hlGkwmrdTvg920VVNghI9S45CjwKk'
    );

    // Récupération de l'utilisateur connecté
    let user = JSON.parse(localStorage.getItem("nffa_user"));
    if (!user) {
      location.href = "login.html";
    }

    document.getElementById("welcome").textContent = `Bienvenue ${user.user} (${user.permission})`;

    // Charger la liste des utilisateurs
    async function loadUsers() {
      const { data, error } = await supabase
        .from("users-nffa")
        .select("*");

      if (error) {
        console.error(error);
        return;
      }

      document.getElementById("userList").innerHTML = data.map(u => {
        let cls = u.permission === "admin" ? "admin" : u.permission === "dispatcher" ? "dispatcher" : "";
        let btn = "";
        if (user.permission === "admin" && u.permission !== "admin") {
          btn = `<button onclick="setDispatcher(${u.id})">Désigner dispatcher</button>`;
        }
        return `<div class="user-item ${cls}">
          ${u.user} - ${u.permission} - Présence: ${u.presence ? "✅" : "❌"}
          ${btn}
        </div>`;
      }).join("");
    }

    // Fonction pour désigner un dispatcher (admin uniquement)
    async function setDispatcher(id) {
      // D'abord, retirer le rôle dispatcher à tout le monde
      await supabase
        .from("users-nffa")
        .update({ permission: "user" })
        .eq("permission", "dispatcher");

      // Ensuite, attribuer le rôle à l'utilisateur sélectionné
      await supabase
        .from("users-nffa")
        .update({ permission: "dispatcher" })
        .eq("id", id);

      loadUsers();
    }

    // Mettre la présence à false à la fermeture de l'onglet
    window.addEventListener("beforeunload", () => {
      navigator.sendBeacon(
        'https://gktawbaposndfxijkxdk.supabase.co/rest/v1/users-nffa',
        JSON.stringify({
          id: user.id,
          presence: false
        })
      );
    });

    // Déconnexion
    async function logout() {
      await supabase
        .from("users-nffa")
        .update({ presence: false })
        .eq("id", user.id);

      localStorage.removeItem("nffa_user");
      location.href = "login.html";
    }

    // Chargement initial
    loadUsers();
  </script>
</body>
</html>
