<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dispatch NFFA</title>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
/* === CSS INCHANG√â === */
body{font-family:Inter,system-ui,sans-serif;margin:0;min-height:100vh;background:url('https://i.imgur.com/A6V1lhN.jpg') no-repeat center center fixed;background-size:cover;color:#1f1f1f}
body::before{content:"";position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,.7);backdrop-filter:blur(4px);z-index:-1}
header{background:linear-gradient(90deg,#e11d48,#991b1b);color:#fff;padding:16px 24px;display:flex;justify-content:space-between;align-items:center}
button{background:#dc2626;color:#fff;border:0;padding:10px 16px;border-radius:10px;cursor:pointer}
button:hover{background:#b91c1c}
.card{max-width:900px;margin:40px auto;padding:24px;border-radius:16px;background:rgba(255,255,255,.95);box-shadow:0 10px 25px rgba(0,0,0,.12)}
.warning-message{background:#fee2e2;border:1px solid #fecaca;color:#991b1b;padding:12px 16px;border-radius:10px;font-size:14px;margin:16px 0;text-align:center;font-weight:500}
#dispatcher-container{width:100%;max-width:1400px;margin:20px auto;text-align:center}
#dispatcher-zone{display:inline-block;width:300px;padding:16px;border:4px solid #e11d48;border-radius:16px;background:#fef2f2;box-shadow:0 8px 20px rgba(0,0,0,.15)}
#board{display:flex;flex-wrap:wrap;justify-content:center;gap:30px;padding:30px;background:rgba(255,255,255,.92);border-radius:16px;margin:20px auto;max-width:1400px}
#available-users{width:320px;min-height:500px;padding:16px;border-radius:16px;background:#fff;box-shadow:0 6px 18px rgba(0,0,0,.12)}
.patrols{display:grid;grid-template-columns:repeat(5,1fr);gap:24px;flex:1}
.patrol-zone{border:3px solid #e11d48;border-radius:16px;background:#fef2f2;min-height:300px;padding:12px;text-align:center;box-shadow:0 6px 18px rgba(0,0,0,.12)}
.members{min-height:180px;margin-top:10px}
.user-tag{display:block;padding:14px 18px;margin:10px 0;background:#fecaca;border-radius:12px;cursor:pointer;font-weight:600}
.user-tag.admin{background:#fca5a5}
.user-tag.dispatcher{background:#f87171;color:#fff}
.patrol-location select{width:90%;padding:8px;border-radius:8px;margin-bottom:8px}
#map-container{height:600px;margin:40px auto;max-width:1400px;border-radius:16px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.2)}
</style>
</head>

<body>
<header>
<strong>Dispatch NFFA</strong>
<button id="logoutBtn">D√©connexion</button>
</header>

<div id="board">
<div id="available-users"><h3>Disponibles</h3></div>
<div class="patrols"></div>
</div>

<div id="map-container">
<div id="patrol-map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const supabase = createClient(
  "https://gktawbaposndfxijkxdk.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdGF3YmFwb3NuZGZ4aWpreGRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwNzUyNDUsImV4cCI6MjA3OTY1MTI0NX0.tY-CHuyb2zr9s6hlGkwmrdTvg920VVNghI9S45CjwKk"
);

let streets = [];
let patrolMap;
let markers = {};

/* üó∫Ô∏è MAP */
patrolMap = L.map('patrol-map').setView([0.5,0.5],3);
L.imageOverlay('https://i.imgur.com/wCJH8tY.png',[[0,0],[1,1]]).addTo(patrolMap);

/* üì• LOAD STREETS */
async function loadStreets(){
  const {data} = await supabase.from("streets").select("*").order("name");
  streets = data || [];
}

/* üì¶ BOARD */
async function createBoardStructure(){
  document.querySelector(".patrols").innerHTML = "";

  for(let i=1;i<=10;i++){
    const div = document.createElement("div");
    div.className="patrol-zone";
    div.innerHTML=`
      <h3>Patrouille ${i}</h3>
      <div class="members"></div>
      <div class="patrol-location">
        <select id="loc-${i}">
          <option value="">-- Choisir une rue --</option>
          ${streets.map(s=>`<option value="${s.id}">${s.name}</option>`).join("")}
        </select>
        <button onclick="updatePatrolLocation(${i})">Mettre √† jour</button>
      </div>
    `;
    document.querySelector(".patrols").appendChild(div);
  }
}

/* üìç UPDATE */
window.updatePatrolLocation = async function(num){
  const select=document.getElementById(`loc-${num}`);
  if(!select.value) return;

  const street=streets.find(s=>s.id==select.value);
  await supabase.from("patrouille").upsert({
    patrol_name:`Patrouille_${num}`,
    localisation:street.name
  },{onConflict:"patrol_name"});

  loadPatrolMarkers();
}

/* üìå MARKERS */
async function loadPatrolMarkers(){
  const {data}=await supabase.from("patrouille").select("*").not("localisation","is",null);

  Object.values(markers).forEach(m=>patrolMap.removeLayer(m));
  markers={};

  data.forEach(p=>{
    const street=streets.find(s=>s.name===p.localisation);
    if(!street) return;
    markers[p.patrol_name]=L.marker([street.lat,street.lng])
      .addTo(patrolMap)
      .bindPopup(`<b>${p.patrol_name}</b><br>${street.name}`);
  });
}

/* üöÄ START */
await loadStreets();
await createBoardStructure();
await loadPatrolMarkers();

setInterval(loadPatrolMarkers,8000);
</script>
</body>
</html>
