<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dispatch NFFA</title>
  <style>
    body {
      font-family: Inter, system-ui, sans-serif;
      margin: 0;
      min-height: 100vh;
      background: url('https://i.imgur.com/A6V1lhN.jpg') no-repeat center center fixed;
      background-size: cover;
      color: #1f1f1f;
    }
    body::before {
      content: "";
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.7);
      backdrop-filter: blur(4px);
      z-index: -1;
    }
    header {
      background: linear-gradient(90deg, #e11d48, #991b1b);
      color: white;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    button {
      background: #dc2626;
      color: white;
      border: 0;
      padding: 10px 16px;
      border-radius: 10px;
      cursor: pointer;
    }
    button:hover { background: #b91c1c; }
    .card {
      max-width: 800px;
      margin: 40px auto;
      padding: 24px;
      border-radius: 16px;
      background: rgba(255,255,255,0.95);
      box-shadow: 0 10px 25px rgba(0,0,0,.12);
    }
    .user-item {
      padding: 10px;
      border: 1px solid #fecaca;
      border-radius: 10px;
      margin: 6px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .user-item.admin { background: #fee2e2; }
    .user-item.dispatcher { background: #fee2e2aa; }
  </style>
</head>
<body>
  <header>
    <strong>Dispatch NFFA</strong>
    <button id="logoutBtn">Déconnexion</button>
  </header>
  <div class="card">
    <h2 id="welcome"></h2>
    <div id="userList"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const SUPABASE_URL = 'https://gktawbaposndfxijkxdk.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdGF3YmFwb3NuZGZ4aWpreGRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwNzUyNDUsImV4cCI6MjA3OTY1MTI0NX0.tY-CHuyb2zr9s6hlGkwmrdTvg920VVNghI9S45CjwKk';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Récupération de l'utilisateur connecté
    let currentUser = JSON.parse(localStorage.getItem("nffa_user"));
    if (!currentUser) {
      window.location.href = "login.html";
    }

    document.getElementById("welcome").textContent = `Bienvenue ${currentUser.user} (${currentUser.permission})`;

    // Chargement de la liste des utilisateurs
    async function loadUsers() {
      const { data, error } = await supabase
        .from("users-nffa")
        .select("*");

      if (error) {
        console.error("Erreur chargement utilisateurs :", error);
        return;
      }

      document.getElementById("userList").innerHTML = data.map(u => {
        const cls = u.permission === "admin" ? "admin" : u.permission === "dispatcher" ? "dispatcher" : "";
        let btn = "";
        if (currentUser.permission === "admin" && u.permission !== "admin") {
          btn = `<button onclick="setDispatcher(${u.id})">Désigner dispatcher</button>`;
        }
        return `<div class="user-item ${cls}">
          ${u.user} - ${u.permission} - Présence: ${u.presence ? "✅" : "❌"}
          ${btn}
        </div>`;
      }).join("");
    }

    // Désigner un dispatcher (admin uniquement)
    window.setDispatcher = async function(id) {
      // Retirer le rôle dispatcher à tous
      await supabase
        .from("users-nffa")
        .update({ permission: "user" })
        .eq("permission", "dispatcher");

      // Donner le rôle à la personne sélectionnée
      await supabase
        .from("users-nffa")
        .update({ permission: "dispatcher" })
        .eq("id", id);

      loadUsers();
    };

    // Mise à jour présence à false (quand on ferme l'onglet ou la fenêtre)
    window.addEventListener("beforeunload", () => {
      navigator.sendBeacon(
        `${SUPABASE_URL}/rest/v1/users-nffa`,
        JSON.stringify({
          presence: false
        })
      );
      // On ajoute les headers nécessaires via une petite astuce (sendBeacon ne permet pas les headers personnalisés)
      // Mais Supabase accepte les PATCH avec filtre via query params
      const url = `${SUPABASE_URL}/rest/v1/users-nffa?id=eq.${currentUser.id}&apikey=${SUPABASE_ANON_KEY}`;
      navigator.sendBeacon(url, JSON.stringify({ presence: false }));
    });

    // Déconnexion manuelle
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await supabase
        .from("users-nffa")
        .update({ presence: false })
        .eq("id", currentUser.id);

      localStorage.removeItem("nffa_user");
      window.location.href = "login.html";
    });

    // Chargement initial
    loadUsers();

    // Optionnel : rafraîchir la liste toutes les 10 secondes pour voir les présences en temps réel
    setInterval(loadUsers, 10000);
  </script>
</body>
</html>
