<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dispatch NFFA</title>
  <!-- CDN pour Sortable.js (pour drag and drop multi-zones) -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
  <style>
    body {
      font-family: Inter, system-ui, sans-serif;
      margin: 0;
      min-height: 100vh;
      background: url('https://i.imgur.com/A6V1lhN.jpg') no-repeat center center fixed;
      background-size: cover;
      color: #1f1f1f;
    }
    body::before {
      content: "";
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.7);
      backdrop-filter: blur(4px);
      z-index: -1;
    }
    header {
      background: linear-gradient(90deg, #e11d48, #991b1b);
      color: white;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    button {
      background: #dc2626;
      color: white;
      border: 0;
      padding: 10px 16px;
      border-radius: 10px;
      cursor: pointer;
    }
    button:hover { background: #b91c1c; }
    .card {
      max-width: 800px;
      margin: 40px auto;
      padding: 24px;
      border-radius: 16px;
      background: rgba(255,255,255,0.95);
      box-shadow: 0 10px 25px rgba(0,0,0,.12);
    }
    .user-item {
      padding: 10px;
      border: 1px solid #fecaca;
      border-radius: 10px;
      margin: 6px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .user-item.admin { background: #fee2e2; }
    .user-item.dispatcher { background: #fee2e2aa; }

    /* Styles pour le tableau blanc */
    #board {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      padding: 20px;
      background: rgba(255,255,255,0.8);
      border-radius: 16px;
      margin: 20px auto;
      max-width: 1200px;
    }
    .drop-zone {
      min-width: 200px;
      min-height: 150px;
      padding: 10px;
      border: 2px dashed #fecaca;
      border-radius: 10px;
      background: #fff;
    }
    .dispatcher-zone {
      position: absolute;
      top: 100px;
      left: 20px;
      width: 200px;
    }
    .available-zone {
      width: 250px;
      height: 400px;
      overflow-y: auto;
    }
    .patrols {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 20px;
      width: 100%;
    }
    .patrol-zone {
      border: 2px solid #e11d48;
      padding: 10px;
      border-radius: 10px;
      background: #fee2e2;
      min-height: 200px;
    }
    .user-tag {
      padding: 8px 12px;
      margin: 4px 0;
      background: #fecaca;
      border-radius: 8px;
      cursor: grab;
      user-select: none;
    }
    .slot {
      min-height: 40px;
      margin: 4px 0;
      border-bottom: 1px dotted #ccc;
    }
    .slot.leader {
      font-weight: bold;
      color: #991b1b;
    }

    /* Message de rappel */
    .warning-message {
      background: #fee2e2;
      border: 1px solid #fecaca;
      color: #991b1b;
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 14px;
      margin: 16px 0;
      text-align: center;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <header>
    <strong>Dispatch NFFA</strong>
    <button id="logoutBtn">Déconnexion</button>
  </header>
  <div class="card">
    <h2 id="welcome"></h2>
    <div class="warning-message">
      ⚠️ Merci de bien cliquer sur « Déconnexion » avant de quitter ou fermer l'onglet pour mettre à jour votre statut correctement.
    </div>
    <div id="userList"></div>
  </div>

  <!-- Tableau blanc ajouté ici -->
  <div id="board">
    <div id="dispatcher-zone" class="drop-zone dispatcher-zone">
      <h3>Dispatcher</h3>
    </div>
    <div id="available-users" class="drop-zone available-zone">
      <h3>Utilisateurs disponibles</h3>
    </div>
    <div class="patrols">
      <!-- Génération dynamique des patrouilles en JS -->
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const SUPABASE_URL = 'https://gktawbaposndfxijkxdk.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdGF3YmFwb3NuZGZ4aWpreGRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwNzUyNDUsImV4cCI6MjA3OTY1MTI0NX0.tY-CHuyb2zr9s6hlGkwmrdTvg920VVNghI9S45CjwKk';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = JSON.parse(localStorage.getItem("nffa_user"));
    if (!currentUser) {
      window.location.href = "login.html";
    }

    document.getElementById("welcome").textContent = `Bienvenue ${currentUser.user} (${currentUser.permission})`;

    // Charger la liste des utilisateurs (non interactive, pour référence)
    async function loadUsers() {
      const { data, error } = await supabase.from("users-nffa").select("*");
      if (error) {
        console.error("Erreur chargement utilisateurs :", error);
        return;
      }
      document.getElementById("userList").innerHTML = data.map(u => {
        const cls = u.permission === "admin" ? "admin" : u.permission === "dispatcher" ? "dispatcher" : "";
        let btn = "";
        if (currentUser.permission === "admin" && u.permission !== "admin") {
          btn = `<button onclick="setDispatcher(${u.id})">Désigner dispatcher</button>`;
        }
        return `<div class="user-item ${cls}">
          ${u.user} - ${u.permission} - Présence: ${u.presence ? "✅" : "❌"}
          ${btn}
        </div>`;
      }).join("");
    }

    // Désigner dispatcher via bouton (compatibilité avec ancien code)
    window.setDispatcher = async function(id) {
      await supabase.from("users-nffa").update({ permission: "user" }).eq("permission", "dispatcher");
      await supabase.from("users-nffa").update({ permission: "dispatcher" }).eq("id", id);
      loadUsers();
      loadBoard();
    };

    // Charger le tableau blanc
    async function loadBoard() {
      const { data: users, error } = await supabase
        .from("users-nffa")
        .select("*")
        .eq("presence", true);

      if (error) {
        console.error("Erreur chargement board :", error);
        return;
      }

      // Vider les zones
      document.getElementById("available-users").innerHTML = '<h3>Utilisateurs disponibles</h3>';
      document.getElementById("dispatcher-zone").innerHTML = '<h3>Dispatcher</h3>';
      const patrolsContainer = document.querySelector(".patrols");
      patrolsContainer.innerHTML = '';

      // Créer les 10 patrouilles
      for (let i = 1; i <= 10; i++) {
        const patrolDiv = document.createElement("div");
        patrolDiv.id = `patrol-${i}`;
        patrolDiv.className = "patrol-zone drop-zone";
        patrolDiv.innerHTML = `
          <h3>Patrouille ${i}</h3>
          <div class="slot leader"></div>
          <div class="slot"></div>
          <div class="slot"></div>
          <div class="slot"></div>
        `;
        patrolsContainer.appendChild(patrolDiv);
      }

      // Placer les users dans les zones appropriées
      users.forEach(u => {
        const tag = document.createElement("div");
        tag.className = "user-tag";
        tag.dataset.userId = u.id;
        tag.textContent = `${u.user} (${u.permission})`;

        if (u.permission === "dispatcher") {
          document.getElementById("dispatcher-zone").appendChild(tag);
        } else if (u.patrol) {
          const patrolZone = document.getElementById(`patrol-${u.patrol}`);
          const slots = patrolZone.querySelectorAll(".slot");
          if (u.position >= 1 && u.position <= 4) {
            slots[u.position - 1].appendChild(tag);
          }
        } else {
          document.getElementById("available-users").appendChild(tag);
        }
      });

      // Initialiser Sortable sur les zones
      initSortable();
    }

    // Initialiser le drag and drop avec Sortable.js
    function initSortable() {
      const isAdmin = currentUser.permission === "admin";
      const isDispatcher = currentUser.permission === "dispatcher";

      // Zone available
      new Sortable(document.getElementById("available-users"), {
        group: 'shared',
        animation: 150,
        onAdd: async (evt) => {
          // Mise à jour Supabase : reset assignment
          await updateUserAssignment(evt.item.dataset.userId, null, null, null);
        }
      });

      // Zone dispatcher (limité à 1, seulement pour admins)
      new Sortable(document.getElementById("dispatcher-zone"), {
        group: 'shared',
        animation: 150,
        onAdd: async (evt) => {
          if (!isAdmin) {
            evt.item.remove(); // Annuler si pas admin
            return;
          }
          if (document.getElementById("dispatcher-zone").children.length > 2) { // >2 car h3 + 1 tag
            evt.item.remove(); // Limite à 1
            return;
          }
          // Reset ancien dispatcher
          await supabase.from("users-nffa").update({ permission: "user" }).eq("permission", "dispatcher");
          // Set nouveau
          await updateUserAssignment(evt.item.dataset.userId, null, null, "dispatcher");
        },
        onRemove: async (evt) => {
          await updateUserAssignment(evt.item.dataset.userId, null, null, "user");
        }
      });

      // Zones patrouilles
      for (let i = 1; i <= 10; i++) {
        const patrolZone = document.getElementById(`patrol-${i}`);
        new Sortable(patrolZone, {
          group: 'shared',
          animation: 150,
          onAdd: async (evt) => {
            if (!isAdmin && !isDispatcher) {
              evt.item.remove(); // Annuler si pas autorisé
              return;
            }
            if (patrolZone.children.length > 5) { // >5 car h3 + 4 slots
              evt.item.remove(); // Limite à 4
              return;
            }
            // Calculer position (basé sur index dans zone)
            const position = Array.from(patrolZone.children).indexOf(evt.item) - 1; // -1 pour h3
            await updateUserAssignment(evt.item.dataset.userId, i, position, null);
          },
          onSort: async (evt) => {
            // Mise à jour positions après reorder
            const tags = patrolZone.querySelectorAll(".user-tag");
            for (let pos = 0; pos < tags.length; pos++) {
              await updateUserAssignment(tags[pos].dataset.userId, i, pos + 1, null);
            }
          },
          onRemove: async (evt) => {
            await updateUserAssignment(evt.item.dataset.userId, null, null, null);
          }
        });
      }
    }

    // Fonction pour update assignment en Supabase
    async function updateUserAssignment(userId, patrol, position, permission) {
      const updates = { patrol, position };
      if (permission) updates.permission = permission;
      await supabase.from("users-nffa").update(updates).eq("id", userId);
      loadBoard(); // Recharger pour refléter changements
    }

    // Mise à jour présence à la fermeture
    window.addEventListener("beforeunload", () => {
      const url = `${SUPABASE_URL}/rest/v1/users-nffa?id=eq.${currentUser.id}`;
      navigator.sendBeacon(url, JSON.stringify({ presence: false }));
    });

    // Déconnexion
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await supabase.from("users-nffa").update({ presence: false }).eq("id", currentUser.id);
      localStorage.removeItem("nffa_user");
      window.location.href = "login.html";
    });

    // Chargement initial
    loadUsers();
    loadBoard();
    setInterval(() => { loadUsers(); loadBoard(); }, 10000); // Rafraîchissement auto
  </script>
</body>
</html>
