<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dispatch NFFA</title>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      font-family: Inter, system-ui, sans-serif;
      margin: 0;
      min-height: 100vh;
      background: url('https://i.imgur.com/A6V1lhN.jpg') no-repeat center center fixed;
      background-size: cover;
      color: #1f1f1f;
    }
    body::before {
      content: "";
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.7);
      backdrop-filter: blur(4px);
      z-index: -1;
    }
    header {
      background: linear-gradient(90deg, #e11d48, #991b1b);
      color: white;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    button {
      background: #dc2626;
      color: white;
      border: 0;
      padding: 10px 16px;
      border-radius: 10px;
      cursor: pointer;
    }
    button:hover { background: #b91c1c; }
    .card {
      max-width: 900px;
      margin: 40px auto;
      padding: 24px;
      border-radius: 16px;
      background: rgba(255,255,255,0.95);
      box-shadow: 0 10px 25px rgba(0,0,0,.12);
    }
    .warning-message {
      background: #fee2e2;
      border: 1px solid #fecaca;
      color: #991b1b;
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 14px;
      margin: 16px 0;
      text-align: center;
      font-weight: 500;
    }

    /* Dispatcher en haut */
    #dispatcher-container {
      width: 100%;
      max-width: 1400px;
      margin: 20px auto;
      text-align: center;
    }
    #dispatcher-zone {
      display: inline-block;
      width: 300px;
      padding: 16px;
      border: 4px solid #e11d48;
      border-radius: 16px;
      background: #fef2f2;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }

    /* Tableau blanc */
    #board {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 30px;
      padding: 30px;
      background: rgba(255,255,255,0.92);
      border-radius: 16px;
      margin: 20px auto;
      max-width: 1400px;
    }
    #available-users {
      width: 320px;
      min-height: 500px;
      padding: 16px;
      border-radius: 16px;
      background: #fff;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
    }
    .patrols {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 24px;
      flex: 1;
    }
    .patrol-zone {
      border: 3px solid #e11d48;
      border-radius: 16px;
      background: #fef2f2;
      min-height: 300px;
      padding: 12px;
      text-align: center;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
    }
    .members {
      min-height: 180px;
      margin-top: 10px;
    }
    .user-tag {
      display: block;
      padding: 14px 18px;
      margin: 10px 0;
      background: #fecaca;
      border-radius: 12px;
      cursor: pointer;
      user-select: none;
      font-weight: 600;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      transition: all 0.2s;
    }
    .user-tag:active { cursor: grabbing; transform: scale(1.08); }
    .user-tag.admin { background: #fca5a5; font-weight: bold; }
    .user-tag.dispatcher { background: #f87171; color: white; font-weight: bold; }
    .patrol-zone .user-tag:first-child::before {
      content: "üëë Team Leader - ";
      color: #991b1b;
      font-weight: bold;
    }

    /* Input localisation */
    .patrol-location {
      margin-top: 15px;
    }
    .patrol-location input {
      width: 90%;
      padding: 8px;
      border: 1px solid #fecaca;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .patrol-location button {
      background: #e11d48;
      padding: 6px 12px;
      border: none;
      border-radius: 8px;
    }

    /* Modal */
    #user-modal, #modal-backdrop {
      display: none;
      position: fixed;
      z-index: 1000;
    }
    #modal-backdrop {
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
    }
    #user-modal {
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      text-align: center;
      max-width: 400px;
    }

    /* Carte */
    #map-container {
      height: 600px;
      margin: 40px auto;
      max-width: 1400px;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,.2);
    }
  </style>
</head>
<body>
  <header>
    <strong>Dispatch NFFA</strong>
    <button id="logoutBtn">D√©connexion</button>
  </header>

  <div class="card">
    <h2 id="welcome"></h2>
    <div class="warning-message">
      ‚ö†Ô∏è Merci de bien cliquer sur ¬´ D√©connexion ¬ª avant de quitter ou fermer l'onglet.
    </div>
    <div id="userList"></div>
  </div>

  <div id="dispatcher-container">
    <div id="dispatcher-zone">
      <h3>üö® Dispatcher en poste</h3>
    </div>
  </div>

  <div id="board">
    <div id="available-users">
      <h3>Disponibles</h3>
    </div>
    <div class="patrols"></div>
  </div>

  <div id="map-container">
    <div id="patrol-map"></div>
  </div>

  <div id="modal-backdrop"></div>
  <div id="user-modal">
    <h3>Fiche Agent</h3>
    <p id="user-name"></p>
    <p id="user-rank"></p>
    <p id="user-unit"></p>
    <button onclick="closeModal()">Fermer</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const SUPABASE_URL = 'https://gktawbaposndfxijkxdk.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdGF3YmFwb3NuZGZ4aWpreGRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwNzUyNDUsImV4cCI6MjA3OTY1MTI0NX0.tY-CHuyb2zr9s6hlGkwmrdTvg920VVNghI9S45CjwKk';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = JSON.parse(localStorage.getItem("nffa_user"));
    if (!currentUser) window.location.href = "login.html";

    document.getElementById("welcome").textContent = `Bienvenue ${currentUser.user} (${currentUser.permission})`;

    // Coordonn√©es des rues (√† compl√©ter !)
    const streetCoords = {
      "Grove Street": [0.48, 0.52],
      "Vinewood Boulevard": [0.35, 0.65],
      "Strawberry Avenue": [0.45, 0.50],
      "Power Street": [0.40, 0.58],
      "Eclipse Boulevard": [0.32, 0.62],
      // Ajoute toutes les rues que tu veux ici
    };

    let patrolMap = null;
    let markers = {};

    // Initialisation de la carte
    function initMap() {
      patrolMap = L.map('patrol-map', { zoomControl: true }).setView([0.5, 0.5], 3);

      // Image de la carte Los Santos (remplace par une HD 8192x8192 si tu en as une)
      const mapUrl = 'https://i.imgur.com/wCJH8tY.png'; // <-- Mets ton URL HD ici
      L.imageOverlay(mapUrl, [[0, 0], [1, 1]]).addTo(patrolMap);

      // Forcer le redimensionnement (bug fr√©quent avec Leaflet en display block tardif)
      setTimeout(() => patrolMap.invalidateSize(), 500);
    }

    // Chargement des marqueurs patrouilles
    async function loadPatrolMarkers() {
      if (!patrolMap) return;

      const { data: patrols, error } = await supabase
        .from("patrouille")
        .select("*")
        .not("localisation", "is", null);

      if (error || !patrols) return;

      // Supprimer anciens marqueurs
      Object.values(markers).forEach(m => patrolMap.removeLayer(m));
      markers = {};

      patrols.forEach(p => {
        const rue = p.localisation.trim();
        if (streetCoords[rue]) {
          const coord = streetCoords[rue];
          const marker = L.marker(coord)
            .addTo(patrolMap)
            .bindPopup(`<b>${p.patrol_name.replace('_', ' ')}</b><br>Rue: ${rue}`)
            .openPopup();

          markers[p.patrol_name] = marker;
        }
      });
    }

    async function loadUsersList() {
      const { data } = await supabase.from("users-nffa").select("*");
      if (!data) return;
      document.getElementById("userList").innerHTML = data.map(u => {
        const cls = u.permission === "admin" ? "admin" : u.permission === "dispatcher" ? "dispatcher" : "";
        const btn = currentUser.permission === "admin" && u.permission !== "admin"
          ? `<button onclick="setDispatcher(${u.id})">D√©signer dispatcher</button>`
          : "";
        return `<div class="user-item ${cls}">${u.user} - ${u.permission} - Pr√©sence: ${u.presence ? "‚úÖ" : "‚ùå"} ${btn}</div>`;
      }).join("");
    }

    window.setDispatcher = async function(id) {
      await supabase.from("users-nffa").update({ permission: "user", patrol: null }).eq("permission", "dispatcher");
      await supabase.from("users-nffa").update({ permission: "dispatcher", patrol: 0 }).eq("id", id);
      loadBoard();
    };

    async function loadBoard() {
      const { data: fresh } = await supabase.from("users-nffa").select("*").eq("id", currentUser.id).single();
      if (fresh) currentUser = fresh;

      const { data: users } = await supabase.from("users-nffa").select("*").eq("presence", true);
      const { data: patrols } = await supabase.from("patrouille").select("*");

      if (!users || !patrols) return;

      document.getElementById("available-users").innerHTML = '<h3>Disponibles</h3>';
      document.getElementById("dispatcher-zone").innerHTML = '<h3>üö® Dispatcher en poste</h3>';
      document.querySelector(".patrols").innerHTML = '';

      for (let i = 1; i <= 10; i++) {
        const patrolName = `Patrouille_${i}`;
        const div = document.createElement("div");
        div.className = "patrol-zone";
        div.innerHTML = `<h3>Patrouille ${i}</h3><div class="members"></div>`;

        const patrolData = patrols.find(p => p.patrol_name === patrolName) || { localisation: '' };
        const locationDiv = document.createElement("div");
        locationDiv.className = "patrol-location";
        locationDiv.innerHTML = `
          <input id="loc-${i}" type="text" placeholder="Ex: Grove Street" value="${patrolData.localisation || ''}">
          <button onclick="updatePatrolLocation(${i})">Mettre √† jour</button>
        `;
        div.appendChild(locationDiv);
        document.querySelector(".patrols").appendChild(div);
      }

      users.forEach(u => {
        const tag = document.createElement("div");
        tag.className = `user-tag ${u.permission}`;
        tag.dataset.userId = u.id;
        tag.dataset.permission = u.permission;
        tag.textContent = u.user;
        tag.addEventListener('dblclick', () => showUserInfo(u.id));

        if (u.permission === "dispatcher" && u.patrol === 0) {
          document.getElementById("dispatcher-zone").appendChild(tag);
        } else if (u.patrol >= 1 && u.patrol <= 10) {
          document.querySelector(`.patrols > .patrol-zone:nth-child(${u.patrol}) .members`).appendChild(tag);
        } else {
          document.getElementById("available-users").appendChild(tag);
        }
      });

      initDragAndDrop();
    }

    // Fonction robuste pour mise √† jour localisation
    window.updatePatrolLocation = async function(num) {
      const input = document.getElementById(`loc-${num}`);
      const localisation = input.value.trim();
      const patrolName = `Patrouille_${num}`;

      // Cherche si la ligne existe d√©j√†
      const { data: existing } = await supabase
        .from("patrouille")
        .select("id")
        .eq("patrol_name", patrolName)
        .single();

      if (existing) {
        await supabase
          .from("patrouille")
          .update({ localisation: localisation || null })
          .eq("id", existing.id);
      } else {
        await supabase
          .from("patrouille")
          .insert({ patrol_name: patrolName, localisation: localisation || null });
      }

      // Mise √† jour imm√©diate de la carte
      loadPatrolMarkers();
    };

    async function showUserInfo(id) {
      const { data } = await supabase.from("users-nffa").select("user, rank, unit").eq("id", id).single();
      if (data) {
        document.getElementById("user-name").textContent = `Nom: ${data.user}`;
        document.getElementById("user-rank").textContent = `Grade: ${data.rank || 'Non d√©fini'}`;
        document.getElementById("user-unit").textContent = `Unit√©: ${data.unit || 'Non d√©finie'}`;
        document.getElementById("user-modal").style.display = 'block';
        document.getElementById("modal-backdrop").style.display = 'block';
      }
    }

    window.closeModal = () => {
      document.getElementById("user-modal").style.display = 'none';
      document.getElementById("modal-backdrop").style.display = 'none';
    };

    function initDragAndDrop() {
      const isAdmin = currentUser.permission === "admin";
      const isDispatcherOnDuty = currentUser.permission === "dispatcher" && currentUser.patrol === 0;
      const canManagePatrols = isAdmin || isDispatcherOnDuty;
      const canManageDispatcher = isAdmin;

      const options = {
        group: "users",
        animation: 200,
        draggable: ".user-tag",
        ghostClass: "sortable-ghost",
        onEnd: async (evt) => {
          if (evt.from === evt.to && evt.oldIndex === evt.newIndex) return;

          const item = evt.item;
          const userId = item.dataset.userId;
          const perm = item.dataset.permission;

          if (!canManagePatrols && evt.to.id !== "available-users") return loadBoard();
          if (evt.to.id === "dispatcher-zone" && (!canManageDispatcher || perm !== "dispatcher")) return loadBoard();

          let patrol = null;
          if (evt.to.closest(".patrol-zone")) {
            patrol = Array.from(document.querySelectorAll(".patrol-zone")).indexOf(evt.to.closest(".patrol-zone")) + 1;
          } else if (evt.to.id === "dispatcher-zone") {
            patrol = 0;
          }

          await supabase.from("users-nffa").update({ patrol }).eq("id", userId);
          loadBoard();
        }
      };

      new Sortable(document.getElementById("available-users"), options);
      new Sortable(document.getElementById("dispatcher-zone"), options);
      document.querySelectorAll(".members").forEach(m => new Sortable(m, options));
    }

    // D√©connexion
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await supabase.from("users-nffa").update({ presence: false }).eq("id", currentUser.id);
      localStorage.removeItem("nffa_user");
      window.location.href = "login.html";
    });

    window.addEventListener("beforeunload", () => {
      navigator.sendBeacon(`${SUPABASE_URL}/rest/v1/users-nffa?id=eq.${currentUser.id}`, JSON.stringify({ presence: false }));
    });

    // D√©marrage
    initMap();
    loadUsersList();
    loadBoard();
    loadPatrolMarkers();

    // Rafra√Æchissement toutes les 5 secondes
    setInterval(() => {
      loadUsersList();
      loadBoard();
      loadPatrolMarkers();
    }, 5000);
  </script>
</body>
</html>
