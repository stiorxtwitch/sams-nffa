<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dispatch NFFA</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  margin:0;
  min-height:100vh;
  font-family:Inter,system-ui;
  background:#fff1f2;
}
header{
  background:linear-gradient(90deg,#e11d48,#991b1b);
  color:white;
  padding:16px 24px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
button{
  background:#dc2626;
  color:white;
  border:0;
  padding:10px 16px;
  border-radius:10px;
  cursor:pointer;
}
button:hover{background:#b91c1c}
.card{
  background:white;
  max-width:600px;
  margin:40px auto;
  padding:24px;
  border-radius:16px;
  box-shadow:0 10px 25px rgba(0,0,0,.12);
}
</style>
</head>

<body>

<header>
  <strong>Dispatch NFFA</strong>
  <button onclick="logout()">Déconnexion</button>
</header>

<div class="card">
  <h2 id="welcome"></h2>
  <p><strong>Permission :</strong> <span id="perm"></span></p>
  <p><strong>Présence :</strong> <span style="color:green">EN SERVICE</span></p>
</div>

<script>
const supabase = supabaseJs.createClient(
  "https://gktawbaposndfxijkxdk.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdGF3YmFwb3NuZGZ4aWpreGRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwNzUyNDUsImV4cCI6MjA3OTY1MTI0NX0.tY-CHuyb2zr9s6hlGkwmrdTvg920VVNghI9S45CjwKk"
)

const user = JSON.parse(localStorage.getItem("nffa_user"))
if(!user){
  location.href = "login.html"
}

welcome.textContent = `Bienvenue ${user.user}`
perm.textContent = user.permission

// présence OFF si onglet fermé
window.addEventListener("beforeunload", () => {
  navigator.sendBeacon(
    "https://gktawbaposndfxijkxdk.supabase.co/rest/v1/users-nffa?id=eq." + user.id,
    JSON.stringify({ presence:false })
  )
})

async function logout(){
  await supabase.from("users-nffa")
    .update({ presence:false })
    .eq("id", user.id)

  localStorage.removeItem("nffa_user")
  location.href="login.html"
}
</script>

</body>
</html>
