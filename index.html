<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dispatch NFFA - SAMS</title>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      font-family: Inter, system-ui, sans-serif;
      margin: 0;
      min-height: 100vh;
      background: url('https://i.imgur.com/A6V1lhN.jpg') no-repeat center center fixed;
      background-size: cover;
      color: #1f1f1f;
    }
    body::before {
      content: "";
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.7);
      backdrop-filter: blur(4px);
      z-index: -1;
    }
    header {
      background: linear-gradient(90deg, #e11d48, #991b1b);
      color: white;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    button {
      background: #dc2626;
      color: white;
      border: 0;
      padding: 10px 16px;
      border-radius: 10px;
      cursor: pointer;
    }
    button:hover { background: #b91c1c; }
    .card {
      max-width: 900px;
      margin: 40px auto;
      padding: 24px;
      border-radius: 16px;
      background: rgba(255,255,255,0.95);
      box-shadow: 0 10px 25px rgba(0,0,0,.12);
    }
    .warning-message {
      background: #fee2e2;
      border: 1px solid #fecaca;
      color: #991b1b;
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 14px;
      margin: 16px 0;
      text-align: center;
      font-weight: 500;
    }

    /* Dispatcher */
    #dispatcher-container {
      width: 100%;
      max-width: 1400px;
      margin: 20px auto;
      text-align: center;
    }
    #dispatcher-zone {
      display: inline-block;
      width: 300px;
      padding: 16px;
      border: 4px solid #e11d48;
      border-radius: 16px;
      background: #fef2f2;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }

    /* Board */
    #board {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 30px;
      padding: 30px;
      background: rgba(255,255,255,0.92);
      border-radius: 16px;
      margin: 20px auto;
      max-width: 1400px;
    }
    #available-users {
      width: 320px;
      min-height: 500px;
      padding: 16px;
      border-radius: 16px;
      background: #fff;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
    }
    .patrols {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 24px;
      flex: 1;
    }
    .patrol-zone {
      border: 3px solid #e11d48;
      border-radius: 16px;
      background: #fef2f2;
      min-height: 340px;
      padding: 12px;
      text-align: center;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      transition: background 0.3s;
    }
    .members {
      min-height: 180px;
      margin-top: 10px;
    }
    .user-tag {
      display: block;
      padding: 14px 18px;
      margin: 10px 0;
      background: #fecaca;
      border-radius: 12px;
      cursor: pointer;
      user-select: none;
      font-weight: 600;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      transition: all 0.2s;
    }
    .user-tag:active { cursor: grabbing; transform: scale(1.08); }
    .user-tag.admin { background: #fca5a5; font-weight: bold; }
    .user-tag.dispatcher { background: #f87171; color: white; font-weight: bold; }
    .patrol-zone .user-tag:first-child::before {
      content: "üëë Team Leader - ";
      color: #991b1b;
      font-weight: bold;
    }

    /* Header patrouille */
    .patrol-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .patrol-header h3 {
      margin: 0;
      cursor: pointer;
    }
    .patrol-statut button {
      background: #6b7280;
      padding: 6px 12px;
      font-size: 12px;
    }

    /* Localisation & v√©hicule */
    .patrol-controls {
      margin-top: 10px;
    }
    .patrol-controls select {
      width: 90%;
      padding: 8px;
      border: 1px solid #fecaca;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .patrol-controls button {
      background: #e11d48;
      padding: 6px 12px;
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 14px;
    }

    /* Couleurs statut */
    .patrol-zone.en-patrouille { background: #d1fae5; border-color: #10b981; }
    .patrol-zone.en-intervention { background: #fee2e2; border-color: #ef4444; }
    .patrol-zone.stand-by { background: #fef9c3; border-color: #f59e0b; }
    .patrol-zone.en-attente { background: #f3f4f6; border-color: #6b7280; }

    /* Modals */
    .modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      z-index: 1001;
      text-align: center;
      max-width: 400px;
    }
    .modal-backdrop {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
    }

    /* Carte - GRANDE ET VISIBLE */
    #map-container {
      width: 90%;
      max-width: 1400px;
      height: 800px; /* Hauteur augment√©e pour bien voir la carte */
      margin: 40px auto;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 15px 40px rgba(0,0,0,0.3);
      background: #000;
    }
    #patrol-map {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <header>
    <strong>Dispatch NFFA - SAMS</strong>
    <button id="logoutBtn">D√©connexion</button>
  </header>

  <div class="card">
    <h2 id="welcome"></h2>
    <div class="warning-message">
      ‚ö†Ô∏è Merci de bien cliquer sur ¬´ D√©connexion ¬ª avant de quitter ou fermer l'onglet.
    </div>
    <div id="userList"></div>
  </div>

  <div id="dispatcher-container">
    <div id="dispatcher-zone">
      <h3>üö® Dispatcher en poste</h3>
    </div>
  </div>

  <div id="board">
    <div id="available-users">
      <h3>Disponibles</h3>
    </div>
    <div class="patrols"></div>
  </div>

  <div id="map-container">
    <div id="patrol-map"></div>
  </div>

  <!-- Modals -->
  <div class="modal-backdrop" id="modal-backdrop"></div>

  <div class="modal" id="user-modal">
    <h3>Fiche Agent</h3>
    <p id="user-name"></p>
    <p id="user-rank"></p>
    <p id="user-unit"></p>
    <button onclick="closeModal('user-modal')">Fermer</button>
  </div>

  <div class="modal" id="statut-modal">
    <h3>Statut de la patrouille</h3>
    <select id="statut-select">
      <option value="en-attente">En Attente de Patrouille</option>
      <option value="stand-by">Stand-By</option>
      <option value="en-patrouille">En Patrouille</option>
      <option value="en-intervention">En Intervention</option>
    </select>
    <button onclick="saveStatut()">Sauvegarder</button>
  </div>

  <div class="modal" id="vehicle-modal">
    <h3>Type de v√©hicule</h3>
    <select id="vehicle-select">
      <option value="">Aucun</option>
      <option value="Voiture de patrouille">Voiture de patrouille</option>
      <option value="Moto">Moto</option>
      <option value="V√©hicule banalis√©">V√©hicule banalis√©</option>
      <option value="4x4">4x4</option>
      <option value="H√©licopt√®re">H√©licopt√®re</option>
    </select>
    <button onclick="saveVehicle()">Sauvegarder</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const SUPABASE_URL = 'https://gktawbaposndfxijkxdk.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdGF3YmFwb3NuZGZ4aWpreGRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwNzUyNDUsImV4cCI6MjA3OTY1MTI0NX0.tY-CHuyb2zr9s6hlGkwmrdTvg920VVNghI9S45CjwKk';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = JSON.parse(localStorage.getItem("nffa_user"));
    if (!currentUser) window.location.href = "login.html";

    document.getElementById("welcome").textContent = `Bienvenue ${currentUser.user} (${currentUser.permission})`;

    const streets = [
      "", "Paleto Bay", "Mount Chiliad", "Grapeseed", "Sandy Shores", "Alamo Sea", "Raton Canyon", "Tongva Hills", "Banham Canyon", "Vinewood Hills", "Rockford Hills", "Downtown Vinewood", "Downtown", "Vespucci Beach", "Del Perro", "Little Seoul", "South Los Santos", "Los Santos International Airport", "Port of Los Santos"
    ];

    const streetCoords = {
      "Paleto Bay": [0.12, 0.12],
      "Mount Chiliad": [0.22, 0.32],
      "Grapeseed": [0.32, 0.22],
      "Sandy Shores": [0.52, 0.32],
      "Alamo Sea": [0.48, 0.38],
      "Raton Canyon": [0.28, 0.42],
      "Tongva Hills": [0.42, 0.52],
      "Banham Canyon": [0.48, 0.62],
      "Vinewood Hills": [0.58, 0.48],
      "Rockford Hills": [0.62, 0.52],
      "Downtown Vinewood": [0.68, 0.48],
      "Downtown": [0.72, 0.58],
      "Vespucci Beach": [0.68, 0.68],
      "Del Perro": [0.72, 0.68],
      "Little Seoul": [0.72, 0.62],
      "South Los Santos": [0.78, 0.72],
      "Los Santos International Airport": [0.88, 0.78],
      "Port of Los Santos": [0.82, 0.82]
    };

    let patrolMap = null;
    let markers = {};
    let currentPatrolNum = null;

    function initMap() {
      patrolMap = L.map('patrol-map', {
        crs: L.CRS.Simple,
        minZoom: 2,
        maxZoom: 7,
        zoomControl: true
      });

      const mapUrl = 'https://i.imgur.com/cCrStMo.png';
      const imageBounds = [[0, 0], [1, 1]];
      L.imageOverlay(mapUrl, imageBounds).addTo(patrolMap);

      patrolMap.fitBounds(imageBounds);

      // Forcer l'affichage complet
      setTimeout(() => {
        patrolMap.invalidateSize(true);
      }, 1000);
    }

    async function loadPatrolMarkers() {
      if (!patrolMap) return;

      const { data: patrols } = await supabase.from("patrouille").select("*");

      Object.values(markers).forEach(m => patrolMap.removeLayer(m));
      markers = {};

      if (patrols) {
        patrols.forEach(p => {
          let coord = [0.95, 0.05]; // Hors carte si pas de localisation
          if (p.localisation && streetCoords[p.localisation]) {
            coord = streetCoords[p.localisation];
          }

          const icon = L.icon({
            iconUrl: 'https://i.imgur.com/VTKJQyv.png',
            iconSize: [50, 50],
            iconAnchor: [25, 25],
            tooltipAnchor: [0, -25]
          });

          const marker = L.marker(coord, { icon })
            .addTo(patrolMap)
            .bindTooltip(p.patrol_name.replace('_', ' '), {
              permanent: false,
              direction: 'top',
              offset: [0, -10]
            });

          markers[p.patrol_name] = marker;
        });
      }
    }

    async function loadUsersList() {
      const { data } = await supabase.from("users-nffa").select("*");
      if (!data) return;
      document.getElementById("userList").innerHTML = data.map(u => {
        const cls = u.permission === "admin" ? "admin" : u.permission === "dispatcher" ? "dispatcher" : "";
        const btn = currentUser.permission === "admin" && u.permission !== "admin"
          ? `<button onclick="setDispatcher(${u.id})">D√©signer dispatcher</button>`
          : "";
        return `<div class="user-item ${cls}">${u.user} - ${u.permission} - Pr√©sence: ${u.presence ? "‚úÖ" : "‚ùå"} ${btn}</div>`;
      }).join("");
    }

    window.setDispatcher = async function(id) {
      await supabase.from("users-nffa").update({ permission: "user", patrol: null }).eq("permission", "dispatcher");
      await supabase.from("users-nffa").update({ permission: "dispatcher", patrol: 0 }).eq("id", id);
      loadBoard();
    };

    async function createBoardStructure() {
      const { data: patrols } = await supabase.from("patrouille").select("*");

      document.querySelector(".patrols").innerHTML = '';

      for (let i = 1; i <= 10; i++) {
        const patrolName = `Patrouille_${i}`;
        const div = document.createElement("div");
        div.className = "patrol-zone";
        const patrolData = patrols?.find(p => p.patrol_name === patrolName) || {};

        div.innerHTML = `
          <div class="patrol-header">
            <h3 ondblclick="openVehicleModal(${i})">Patrouille ${i}</h3>
            <div class="patrol-statut">
              <button onclick="openStatutModal(${i})">Statut</button>
            </div>
          </div>
          <div class="members"></div>
          <div class="patrol-controls">
            <select id="loc-${i}">
              ${streets.map(s => `<option value="${s}" ${patrolData.localisation === s ? 'selected' : ''}>${s || 'Aucune localisation'}</option>`).join('')}
            </select>
            <button onclick="updateLocation(${i})">Mettre √† jour localisation</button>
          </div>
        `;

        if (patrolData.statut) {
          div.classList.add(patrolData.statut);
        }

        document.querySelector(".patrols").appendChild(div);
      }
    }

    async function loadBoard() {
      const { data: fresh } = await supabase.from("users-nffa").select("*").eq("id", currentUser.id).single();
      if (fresh) currentUser = fresh;

      const { data: users } = await supabase.from("users-nffa").select("*").eq("presence", true);
      if (!users) return;

      document.getElementById("available-users").innerHTML = '<h3>Disponibles</h3>';
      document.getElementById("dispatcher-zone").innerHTML = '<h3>üö® Dispatcher en poste</h3>';
      document.querySelectorAll(".members").forEach(m => m.innerHTML = '');

      users.forEach(u => {
        const tag = document.createElement("div");
        tag.className = `user-tag ${u.permission}`;
        tag.dataset.userId = u.id;
        tag.dataset.permission = u.permission;
        tag.textContent = u.user;
        tag.addEventListener('dblclick', () => showUserInfo(u.id));

        if (u.permission === "dispatcher" && u.patrol === 0) {
          document.getElementById("dispatcher-zone").appendChild(tag);
        } else if (u.patrol >= 1 && u.patrol <= 10) {
          document.querySelector(`.patrols > .patrol-zone:nth-child(${u.patrol}) .members`).appendChild(tag);
        } else {
          document.getElementById("available-users").appendChild(tag);
        }
      });

      initDragAndDrop();
    }

    window.openStatutModal = function(num) {
      currentPatrolNum = num;
      document.getElementById("statut-modal").style.display = "block";
      document.getElementById("modal-backdrop").style.display = "block";
    };

    window.saveStatut = async function() {
      const statut = document.getElementById("statut-select").value;
      const patrolName = `Patrouille_${currentPatrolNum}`;

      const { data: existing } = await supabase.from("patrouille").select("id").eq("patrol_name", patrolName).single();
      if (existing) {
        await supabase.from("patrouille").update({ statut }).eq("id", existing.id);
      } else {
        await supabase.from("patrouille").insert({ patrol_name: patrolName, statut });
      }

      closeModal("statut-modal");
      createBoardStructure();
      loadBoard();
    };

    window.openVehicleModal = function(num) {
      currentPatrolNum = num;
      document.getElementById("vehicle-modal").style.display = "block";
      document.getElementById("modal-backdrop").style.display = "block";
    };

    window.saveVehicle = async function() {
      const vehicle = document.getElementById("vehicle-select").value;
      const patrolName = `Patrouille_${currentPatrolNum}`;

      const { data: existing } = await supabase.from("patrouille").select("id").eq("patrol_name", patrolName).single();
      if (existing) {
        await supabase.from("patrouille").update({ vehicle }).eq("id", existing.id);
      } else {
        await supabase.from("patrouille").insert({ patrol_name: patrolName, vehicle });
      }

      closeModal("vehicle-modal");
    };

    window.updateLocation = async function(num) {
      const select = document.getElementById(`loc-${num}`);
      const localisation = select.value || null;
      const patrolName = `Patrouille_${num}`;

      const { data: existing } = await supabase.from("patrouille").select("id").eq("patrol_name", patrolName).single();
      if (existing) {
        await supabase.from("patrouille").update({ localisation }).eq("id", existing.id);
      } else {
        await supabase.from("patrouille").insert({ patrol_name: patrolName, localisation });
      }

      loadPatrolMarkers();
    };

    async function showUserInfo(id) {
      const { data } = await supabase.from("users-nffa").select("user, rank, unit").eq("id", id).single();
      if (data) {
        document.getElementById("user-name").textContent = `Nom: ${data.user}`;
        document.getElementById("user-rank").textContent = `Grade: ${data.rank || 'Non d√©fini'}`;
        document.getElementById("user-unit").textContent = `Unit√©: ${data.unit || 'Non d√©finie'}`;
        document.getElementById("user-modal").style.display = "block";
        document.getElementById("modal-backdrop").style.display = "block";
      }
    }

    window.closeModal = function(modalId) {
      document.getElementById(modalId).style.display = "none";
      document.getElementById("modal-backdrop").style.display = "none";
    };

    function initDragAndDrop() {
      const isAdmin = currentUser.permission === "admin";
      const isDispatcherOnDuty = currentUser.permission === "dispatcher" && currentUser.patrol === 0;
      const canManagePatrols = isAdmin || isDispatcherOnDuty;
      const canManageDispatcher = isAdmin;

      const options = {
        group: "users",
        animation: 200,
        draggable: ".user-tag",
        ghostClass: "sortable-ghost",
        onEnd: async (evt) => {
          if (evt.from === evt.to && evt.oldIndex === evt.newIndex) return;

          const item = evt.item;
          const userId = item.dataset.userId;
          const perm = item.dataset.permission;

          if (!canManagePatrols && evt.to.id !== "available-users") return loadBoard();
          if (evt.to.id === "dispatcher-zone" && (!canManageDispatcher || perm !== "dispatcher")) return loadBoard();

          let patrol = null;
          if (evt.to.closest(".patrol-zone")) {
            patrol = Array.from(document.querySelectorAll(".patrol-zone")).indexOf(evt.to.closest(".patrol-zone")) + 1;
          } else if (evt.to.id === "dispatcher-zone") {
            patrol = 0;
          }

          await supabase.from("users-nffa").update({ patrol }).eq("id", userId);
          loadBoard();
        }
      };

      new Sortable(document.getElementById("available-users"), options);
      new Sortable(document.getElementById("dispatcher-zone"), options);
      document.querySelectorAll(".members").forEach(m => new Sortable(m, options));
    }

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await supabase.from("users-nffa").update({ presence: false }).eq("id", currentUser.id);
      localStorage.removeItem("nffa_user");
      window.location.href = "login.html";
    });

    window.addEventListener("beforeunload", () => {
      navigator.sendBeacon(`${SUPABASE_URL}/rest/v1/users-nffa?id=eq.${currentUser.id}`, JSON.stringify({ presence: false }));
    });

    // D√©marrage
    initMap();
    createBoardStructure();
    loadUsersList();
    loadBoard();
    loadPatrolMarkers();

    setInterval(() => {
      loadUsersList();
      loadBoard();
      loadPatrolMarkers();
    }, 8000);
  </script>
</body>
</html>
